<project>
    <description>Process all container/bin</description>

    <target name="process-bin">
        <echo message="Files start*, stop*: call trun instead of karaf" />
        <replaceregexp byline="false" flags="gim"
                       match="(bin[/\\])karaf"
                       replace="\1trun">
            <fileset dir="target/container/bin">
                <include name="start*" />
                <include name="stop*" />
            </fileset>
        </replaceregexp>
        <echo message="File start.bat: remove start to avoid opening a new window" />
        <replaceregexp byline="false" flags="gim"
                       match="start &quot;%KARAF_TITLE%&quot; /MIN "
                       replace="">
            <fileset dir="target/container/bin">
                <include name="start.bat" />
            </fileset>
        </replaceregexp>
        <echo message="File setenv*: update JAVA_MAX_MEM" />
        <replaceregexp byline="false" flags="gim"
                       match="(#|rem) (export|SET) JAVA_MAX_MEM(.*)"
                       replace="\2 JAVA_MAX_MEM=2048M\3">
            <fileset dir="target/container/bin">
                <include name="setenv*" />
            </fileset>
        </replaceregexp>
        <echo message="File setenv: add JAVA_TOOL_OPTIONS" />
        <echo message="&#10;export &quot;JAVA_TOOL_OPTIONS=-Dlog4j2.formatMsgNoLookups=true&quot;"
              file="target/container/bin/setenv"
              append="true" />
        <echo message="&#10;SET &quot;JAVA_TOOL_OPTIONS=-Dlog4j2.formatMsgNoLookups=true&quot;"
              file="target/container/bin/setenv.bat"
              append="true" />

        <!-- specific to this version -->
        <echo message="Files client*, start*, stop*: add KARAF_SCRIPT condition" />
        <replaceregexp byline="false" flags="im"
                       match="^.*KARAF_SCRIPT=&quot;\$\{PROGNAME\}&quot;[\s\S]+?export KARAF_SCRIPT.*$"
                       replace="if [ &quot;x&#36;{KARAF_SCRIPT}&quot; = &quot;x&quot; ]; then&#10;\0&#10;fi">
            <fileset dir="target/container/bin">
                <include name="client*" />
                <include name="start*" />
                <include name="stop*" />
                <include name="trun*" />
            </fileset>
        </replaceregexp>
        
        <echo message="File trun*: add eclipse jetty JVM params" />
        <replaceregexp byline="false" flags="gim"
                       match="^.*\$\{KARAF_SYSTEM_OPTS\}.*$"
                       replace="
                    -Dorg.eclipse.jetty.util.log.class=org.eclipse.jetty.util.log.JavaUtilLog \\\\&#10;
                    -Dorg.eclipse.jetty.LEVEL=INFO \\\\&#10;\0">
            <fileset dir="target/container/bin">
                <include name="trun*" />
            </fileset>
        </replaceregexp>

    </target>
</project>
